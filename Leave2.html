<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>ฟอร์มขอลางาน</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
        /* เพิ่มเพื่อให้เนื้อหาไม่ชิดขอบจอเกินไปบนมือถือ */
        padding: 0 10px;
      }
      label {
        display: block;
        margin-top: 15px; /* เพิ่มระยะห่างเล็กน้อย */
        font-weight: bold; /* ทำให้ label ชัดขึ้น */
      }
      input[type="text"], input[type="email"], input[type="date"], select {
        width: 60%;
        padding: 12px; /* เพิ่ม padding ให้ใหญ่ขึ้น */
        margin-top: 5px;
        box-sizing: border-box;
        border: 1px solid #ccc; /* เพิ่มขอบให้ชัดเจน */
        border-radius: 4px; /* มุมมนเล็กน้อย */
        font-size: 1em; /* ปรับ font ให้เหมาะสม */
      }
      input[type="checkbox"] {
        margin-right: 5px;
        /* ทำให้ checkbox ใหญ่ขึ้นเล็กน้อย */
        width: 18px;
        height: 18px;
        vertical-align: middle; /* จัดให้อยู่กึ่งกลางแนวตั้งกับ label */
      }
       /* ทำให้ label ของ checkbox คลิกได้ */
      label[for="singleDay"] {
        display: inline-block; /* เปลี่ยนเป็น inline-block */
        margin-top: 15px; /* จัดระยะห่าง */
        font-weight: normal; /* ไม่ต้องตัวหนา */
        vertical-align: middle;
      }

      /* --- ส่วนที่แก้ไข: สไตล์ปุ่ม --- */
      button {
        display: block; /* ทำให้ width 100% ทำงาน */
        width: 40%; /* ทำให้ปุ่มกว้างเต็มฟอร์ม */
        padding: 15px 20px; /* เพิ่ม padding แนวตั้งให้ปุ่มสูงขึ้น */
        margin-top: 30px; /* เพิ่มระยะห่างด้านบน */
        font-size: 1.2em; /* เพิ่มขนาดตัวอักษร */
        font-weight: bold; /* ทำให้ตัวอักษรหนา */
        color: white; /* สีตัวอักษร */
        background-color: #007bff; /* สีพื้นหลังปุ่ม (ตัวอย่าง: สีน้ำเงิน) */
        border: none; /* เอาเส้นขอบออก */
        border-radius: 5px; /* ทำให้มุมมน */
        cursor: pointer; /* เปลี่ยน cursor เป็นรูปมือ */
        box-sizing: border-box; /* คำนวณ padding รวมใน width */
        text-align: center; /* จัดข้อความกึ่งกลาง */
        transition: background-color 0.2s ease; /* เพิ่ม animation ตอน hover */
      }

      /* เพิ่ม effect ตอนเอาเมาส์ชี้ (hover) */
      button:hover {
        background-color: #0056b3; /* ทำให้สีเข้มขึ้นเล็กน้อย */
      }
      /* --- สิ้นสุดการแก้ไข: สไตล์ปุ่ม --- */

      .error { color: red; font-size: 0.9em; margin-top: 5px; }
      #loading, #status { margin-top: 15px; font-weight: bold; }
      #loading { display: none; color: blue; }
      #status.success { color: green; }
      #status.error { color: red; }

      /* จัดการการแสดงผลของช่อง End Date */
      #endDateContainer {
         /* ไม่ต้องซ่อน/แสดงแล้ว แค่จัดการ required ผ่าน JS */
      }
    </style>
  </head>
  <body>
    <h1>แบบฟอร์มขอลางาน</h1>
    <div id="liffAppContent" style="display: none;"> <form id="leaveForm">
            <label for="name">ชื่อ-นามสกุล:</label>
            <input type="text" id="name" name="name" required readonly>

            <label for="branch">สาขา:</label>
            <input type="text" id="branch" name="branch" required>

            <label for="employeeId">เลขประจำตัว:</label>
            <input type="text" id="employeeId" name="employeeId" required>

            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>

            <label for="leaveType">ประเภทการลา:</label>
            <select id="leaveType" name="leaveType" required>
                <option value="">-- เลือกประเภทการลา --</option>
                <option value="ลากิจ">ลากิจ</option>
                <option value="ลาป่วย">ลาป่วย</option>
                <option value="ลาพักร้อน">ลาพักร้อน</option>
                <option value="ลาฉุกเฉิน">ลาฉุกเฉิน</option>
            </select>
            <div id="leaveTypeError" class="error"></div>

            <label for="startDate">วันที่ต้องการลา:</label>
            <input type="date" id="startDate" name="startDate" required>
            <div id="startDateError" class="error"></div>

            <div class="checkbox-container">
                <input type="checkbox" id="singleDay" name="singleDay">
                <label for="singleDay">ลาวันเดียว</label>
            </div>

            <div id="endDateContainer">
                <label for="endDate">ลาถึงวันที่:</label>
                <input type="date" id="endDate" name="endDate">
                <div id="endDateError" class="error"></div>
            </div>

            <button type="button" onclick="submitForm()">ส่งคำขอลา</button>
        </form>

    <div id="loading">กำลังประมวลผล...</div>
    <div id="status"></div>
    </div>
    <div id="liffErrorMessage"></div>
    <script>
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email'); // เพิ่ม email input element
        const form = document.getElementById('leaveForm');
        const loadingDiv = document.getElementById('loading');
        const statusDiv = document.getElementById('status');
        const liffAppContent = document.getElementById('liffAppContent');
        const liffErrorMessage = document.getElementById('liffErrorMessage');

         const leaveTypeSelect = document.getElementById('leaveType');
         const startDateInput = document.getElementById('startDate');
         const endDateInput = document.getElementById('endDate');
         const singleDayCheckbox = document.getElementById('singleDay');
         const endDateContainer = document.getElementById('endDateContainer');
         const branchInput = document.getElementById('branch');
         const employeeIdInput = document.getElementById('employeeId');
         const leaveTypeErrorDiv = document.getElementById('leaveTypeError');
         const startDateErrorDiv = document.getElementById('startDateError');
         const endDateErrorDiv = document.getElementById('endDateError');
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyi1SPjIJY0x-AChbRtwLv8A2QR532uqjwluDr3Ym0euh7mqiUcXeS3t2BWQY1SSJfrYQ/exec";
         const today = new Date();
         const todayStr = today.toISOString().split('T')[0];


      // --- จัดการ Checkbox ลาวันเดียว ---
      singleDayCheckbox.addEventListener('change', function() {
        endDateContainer.style.display = this.checked ? 'none' : 'block';
        endDateInput.required = !this.checked; // ถ้าติ๊ก ไม่ต้องกรอกวันที่สิ้นสุด
        if (this.checked) {
          endDateInput.value = ''; // ล้างค่าถ้าติ๊ก
          endDateErrorDiv.textContent = ''; // ล้าง error
        } else {
           endDateInput.required = true; // ถ้าไม่ติ๊ก ให้ required อีกครั้ง
        }
      });

      // --- ตรวจสอบวันที่เมื่อมีการเปลี่ยนแปลง ---
      startDateInput.addEventListener('change', validateLeaveDates);
      endDateInput.addEventListener('change', validateLeaveDates); // เพิ่มให้เช็ค endDate ด้วย
      leaveTypeSelect.addEventListener('change', validateLeaveDates);

      function validateLeaveDates() {
        clearErrors();
        const leaveType = leaveTypeSelect.value;
        const startDate = startDateInput.value;

        if (!startDate) return true; // ยังไม่เลือกวันเริ่ม ไม่ต้อง validate

        const selectedStartDate = new Date(startDate + 'T00:00:00');
        const minLeaveDate = new Date(today);
        minLeaveDate.setHours(0,0,0,0); // กำหนดเวลาเป็น 00:00 เพื่อเปรียบเทียบวันที่เท่านั้น
        minLeaveDate.setDate(today.getDate() + 30);

        // 1. ตรวจสอบเงื่อนไข 30 วัน สำหรับลากิจ/พักร้อน
        if ((leaveType === 'ลากิจ' || leaveType === 'ลาพักร้อน') && selectedStartDate < minLeaveDate) {
          startDateErrorDiv.textContent = 'การ' + leaveType + 'ต้องแจ้งล่วงหน้าอย่างน้อย 30 วัน หากต้องการลาเร็วกว่านี้ โปรดเลือก "ลาฉุกเฉิน"';
          return false;
        }

        // 2. ตรวจสอบวันหยุดสุดสัปดาห์สำหรับ "ลากิจ"
        if (leaveType === 'ลากิจ') {
           const dayOfWeek = selectedStartDate.getDay();
           if (dayOfWeek === 0 || dayOfWeek === 6) {
               startDateErrorDiv.textContent = 'ไม่สามารถ "ลากิจ" ในวันเสาร์-อาทิตย์ได้ กรุณาเลือก "ลาพักร้อน" หรือ "ลาฉุกเฉิน"';
               return false;
           }
           // ตรวจสอบช่วงวันที่ (ถ้ามี end date)
           if (!singleDayCheckbox.checked && endDateInput.value) {
               const endDate = new Date(endDateInput.value + 'T00:00:00');
               if (endDate >= selectedStartDate) { // เช็คว่า endDate ไม่น้อยกว่า startDate ก่อนวน loop
                  let currentDate = new Date(selectedStartDate);
                  while (currentDate <= endDate) {
                      const currentDayOfWeek = currentDate.getDay();
                      if (currentDayOfWeek === 0 || currentDayOfWeek === 6) {
                          endDateErrorDiv.textContent = 'ช่วงวันที่ลา มีวันเสาร์-อาทิตย์ ไม่สามารถใช้ "ลากิจ" ได้';
                          return false;
                      }
                      currentDate.setDate(currentDate.getDate() + 1);
                  }
               }
           }
        }

        // 3. ตรวจสอบวันที่สิ้นสุดต้องไม่น้อยกว่าวันเริ่มต้น
        if (!singleDayCheckbox.checked && endDateInput.value && startDateInput.value) {
            const endDate = new Date(endDateInput.value + 'T00:00:00');
             if (endDate < selectedStartDate) {
                 endDateErrorDiv.textContent = 'วันที่สิ้นสุดต้องไม่น้อยกว่าวันที่เริ่มต้น';
                 return false;
             }
        }

        return true; // ผ่านการตรวจสอบเบื้องต้น
      }

      function clearErrors() {
          startDateErrorDiv.textContent = '';
          endDateErrorDiv.textContent = '';
          leaveTypeErrorDiv.textContent = '';
          statusDiv.textContent = '';
          statusDiv.className = '';
      }
async function main() {
            try {
             
                await liff.init({ liffId: "2007047383-kBQ8DBxy" }); // <--- ใส่ LIFF ID ของคุณ

                if (!liff.isLoggedIn()) {

                    liff.login();
                    return; // หยุดการทำงาน รอ redirect
                }

                // 3. ดึงข้อมูล Profile (ถ้าทำได้)
                const profile = await liff.getProfile();
                nameInput.value = profile.displayName;
                liffAppContent.style.display = 'block';
                initializeFormState(); // เรียกฟังก์ชันตั้งค่าเริ่มต้นของฟอร์ม

            } catch (err) {
                console.error("LIFF Initialization failed", err);
                liffErrorMessage.textContent = `เกิดข้อผิดพลาดในการเปิดแอป: ${err.message}. กรุณาลองเปิดใหม่อีกครั้ง`;
            }
        }

        // --- ฟังก์ชันตั้งค่าเริ่มต้นฟอร์ม ---
         function initializeFormState() {
             endDateContainer.style.display = singleDayCheckbox.checked ? 'none' : 'block';
             endDateInput.required = !singleDayCheckbox.checked;
         }


        // --- 4. แก้ไขฟังก์ชัน submitForm ---
        async function submitForm() {
            clearErrors();
            endDateInput.required = !singleDayCheckbox.checked;

            if (!form.checkValidity()) {

                let firstInvalidField = null; Array.from(form.elements).forEach(element => { if (element.willValidate && !element.checkValidity()) { if (!firstInvalidField) firstInvalidField = element; const errorDiv = document.getElementById(element.id + 'Error'); if (errorDiv) { errorDiv.textContent = element.validationMessage; } } }); if (firstInvalidField) { firstInvalidField.focus(); statusDiv.textContent = 'กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง'; statusDiv.className = 'error'; } else { statusDiv.textContent = 'กรุณาตรวจสอบข้อมูลในฟอร์มอีกครั้ง'; statusDiv.className = 'error'; }
                return;
            }
            if (!validateLeaveDates()) { return; }

            loadingDiv.style.display = 'block';
            statusDiv.textContent = '';
            statusDiv.className = '';

            const formData = {
                
                name: nameInput.value.trim(),
                branch: branchInput.value.trim(),
                employeeId: employeeIdInput.value.trim(),
                email: emailInput.value.trim(),
                leaveType: leaveTypeSelect.value,
                startDate: startDateInput.value,
                endDate: singleDayCheckbox.checked ? startDateInput.value : endDateInput.value,
                singleDay: singleDayCheckbox.checked,
        
            };

            try {

                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',

                    headers: {

                        'Content-Type': 'application/json; charset=utf-8', // ส่งเป็น JSON
                    },
                    body: JSON.stringify(formData) 
                });

                 loadingDiv.style.display = 'none';

              
                 if (!response.ok) {
                 
                    let errorMsg = `เกิดข้อผิดพลาดจากเซิร์ฟเวอร์: ${response.status} ${response.statusText}`;
                     try {
                        const errorData = await response.json();
                        errorMsg = `เกิดข้อผิดพลาด: ${errorData.message || errorMsg}`;
                     } catch (e) { /* ไม่สามารถ parse JSON ได้ ใช้ข้อความเดิม */ }
                     statusDiv.textContent = errorMsg;
                     statusDiv.className = 'error';
                     return;
                 }

                const result = await response.json();

                if (result.success) {
                    statusDiv.innerHTML = result.message.replace(/\n/g, '<br>') || 'ส่งคำขอลางานสำเร็จ!';
                    statusDiv.className = 'success';
                    form.reset();
                    initializeFormState();
                    if (liff.isInClient()) {
                        try {
                            await liff.sendMessages([
                                {
                                    type: 'text',
                                    text: `ส่งคำขอลางานประเภท "${formData.leaveType}" วันที่ ${formData.startDate} สำเร็จแล้ว (Event ID: ${result.message.split('Event ID: ')[1] || 'N/A'})` // อาจจะต้อง parse event id จาก message
                                }
                            ]);
                            // หน่วงเวลาเล็กน้อยก่อนปิด เพื่อให้ user เห็นข้อความสำเร็จบนหน้าจอ
                             setTimeout(() => {
                                 liff.closeWindow();
                             }, 3000);

                        } catch (sendErr) {
                             console.error("Error sending message or closing LIFF:", sendErr);
                        }
                    }

                } else {
          
                    statusDiv.textContent = 'เกิดข้อผิดพลาด: ' + result.message;
                    statusDiv.className = 'error';
                     // แสดง error ที่ field ถ้ามี
                     if (result.field) {
                        const errorDiv = document.getElementById(result.field + 'Error');
                        if (errorDiv) { errorDiv.textContent = result.message; }
                         const fieldToFocus = document.getElementById(result.field);
                         if(fieldToFocus) fieldToFocus.focus();
                    }
                }

            } catch (error) {
                loadingDiv.style.display = 'none';
                statusDiv.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message;
                statusDiv.className = 'error';
                console.error('Fetch Error:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', main);

    </script>
  </body>
</html>

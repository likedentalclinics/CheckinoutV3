<!DOCTYPE html>
<html>
<head>
    <title>แบบฟอร์ม LIFF</title>
    <script src="https://static.line-scdn.net/liff/edge/2.0/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /*  สไตล์เพิ่มเติม (optional) */
        #signatureCanvas {
            touch-action: none; /* ป้องกัน default touch behavior */
            cursor: crosshair;  /* เปลี่ยน cursor เป็น crosshair */
        }
    </style>
</head>
<body>
    <form id="myForm">
        <input type="hidden" id="userLineId">
        <label for="name">ชื่อ:</label>
        <input type="text" id="name" required><br><br>
        <label for="keynumber">เลขประจำตัว:</label>
        <input type="text" id="keynumber" required><br><br>
        <label for="signature">ลายเซ็น:</label><br>
        <canvas id="signatureCanvas" width="400" height="200" style="border:1px solid #000;"></canvas><br>
        <button type="button" id="clearCanvas">ล้างลายเซ็น</button><br><br>
        <button type="button" id="submitBtn">ยืนยัน</button>
    </form>

    <script>
        async function main() {
            try {
                await liff.init({ liffId: "2007047383-9n1A0g3Y" }); // แทนที่ YOUR_LIFF_ID ด้วย LIFF ID ของคุณ
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    document.getElementById("userLineId").value = profile.userId;
                } else {
                    liff.login();
                }


                const canvas = document.getElementById("signatureCanvas");
                const ctx = canvas.getContext("2d");
                ctx.beginPath();
                ctx.moveTo(50, 50);
                ctx.lineTo(100, 100);
                ctx.stroke();
                ctx.strokeStyle = "#000";
                ctx.lineWidth = 2;
                ctx.lineCap = "round";
                ctx.lineJoin = "round";
                let drawing = false;

                function getMousePos(canvas, evt) {
                    var rect = canvas.getBoundingClientRect();
                    return {
                        x: evt.clientX - rect.left,
                        y: evt.clientY - rect.top
                    };
                }

               function startDrawing(e) {
                    drawing = true;
                    let pos = getMousePos(canvas, e);  // ใช้ฟังก์ชันช่วยหาตำแหน่ง
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y);
                    e.preventDefault(); // ป้องกัน default behavior (เช่น scroll)
                }

                function draw(e) {
                    if (!drawing) return;
                    let pos = getMousePos(canvas, e);
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                    e.preventDefault();
                }

                function stopDrawing() {
                    drawing = false;
                }

                canvas.addEventListener("mousedown", startDrawing);
                canvas.addEventListener("mousemove", draw);
                canvas.addEventListener("mouseup", stopDrawing);
                canvas.addEventListener("mouseout", stopDrawing);

                 // Touch events
                canvas.addEventListener("touchstart", (e) => {
                    let touch = e.touches[0];
                    startDrawing(touch);
                });
                canvas.addEventListener("touchmove", (e) => {
                    let touch = e.touches[0];
                    draw(touch);
                });
                canvas.addEventListener("touchend", stopDrawing);



                document.getElementById("clearCanvas").addEventListener("click", () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                });

                document.getElementById("submitBtn").addEventListener("click", async () => {
                    const userLineId = document.getElementById("userLineId").value;
                    const name = document.getElementById("name").value;
                    const keynumber = document.getElementById("keynumber").value;
                    const signatureDataUrl = canvas.toDataURL("image/png");

                   const response = await fetch("https://script.google.com/macros/s/AKfycbzSerwuPr3tV_kb_bWIayfabD_wCVk_iSVj0gjyBjeek70aeEtIK3aTiHh17VZD0Gtq/exec", { // แทนที่ YOUR_APPS_SCRIPT_URL
                        method: "POST",
                        body: JSON.stringify({ userLineId, name, keynumber, signatureDataUrl }),
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    if (response.ok) {
                        Swal.fire({
                            icon: "success",
                            title: "บันทึกข้อมูลสำเร็จ!",
                        });
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "เกิดข้อผิดพลาดในการบันทึกข้อมูล",
                            text: `Status: ${response.status} - ${response.statusText}` // แสดง status code และ text
                        });
                    }
                });
            } catch (error) {
                console.error("LIFF or other error:", error);
                Swal.fire({
                    icon: "error",
                    title: "เกิดข้อผิดพลาด",
                    text: error.message || "Unknown error", // แสดง error message
                });
            }
        }

        main();
    </script>
</body>
</html>
